# Dockerfile - alpine
# https://github.com/openresty/docker-openresty

ARG DR_IMAGE_BASE=alpine
ARG DR_IMAGE_TAG=3.18.4

ARG DR_DB_HOST=""
ARG DR_DB_USER=""
ARG DR_DB_PASSWORD=""
ARG DR_DB_NAME=""
ARG DR_DB_PORT="3306"

ARG DR_MINIO_HOST=""
ARG DR_MINIO_ACCESS_KEY=""
ARG DR_MINIO_SECRET_KEY=""
ARG DR_MINIO_BUCKET=""

FROM ${DR_IMAGE_BASE}:${DR_IMAGE_TAG}

LABEL maintainer="Balinder Walia <bwalia@workstation.co.uk>"

RUN apk update && apk upgrade \
    bash jq wget && \
    apk add mysql-client && \
    wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc \
    --tries=3 --timeout=30 && \
    chmod +x /usr/local/bin/mc

WORKDIR /app

COPY ./backup_database.sh /app/backup_database.sh
RUN chmod +x /app/backup_database.sh

ENV DB_HOST=$DR_DB_HOST
ENV DB_USER=$DR_DB_USER
ENV DB_PASSWORD=$DR_DB_PASSWORD
ENV DB_NAME=$DR_DB_NAME
ENV DB_PORT=$DR_DB_PORT

ENV MINIO_HOST=$DR_MINIO_HOST
ENV MINIO_ACCESS_KEY=$DR_MINIO_ACCESS_KEY
ENV MINIO_SECRET_KEY=$DR_MINIO_SECRET_KEY
ENV MINIO_BUCKET=$DR_MINIO_BUCKET

#ENTRYPOINT ["/opt/dr/backup_database.sh" ]
CMD ["sh", "backup_database.sh"]